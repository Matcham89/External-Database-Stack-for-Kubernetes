services:
  # SeaweedFS Master
  seaweedfs-master:
    image: chrislusf/seaweedfs:3.80
    container_name: seaweedfs-master
    ports:
      - "9333:9333"
      - "19333:19333"
      - "9324:9324"   # metrics
    command: >
      master
      -ip=seaweedfs-master
      -ip.bind=0.0.0.0
      -metricsIp=0.0.0.0
      -metricsPort=9324
    volumes:
      - /mnt/data/seaweedfs/master:/data
    networks:
      - storage-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9333/cluster/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1"
        reservations:
          memory: 256M
          cpus: "0.5"

  # SeaweedFS Volume Server
  seaweedfs-volume:
    image: chrislusf/seaweedfs:3.80
    container_name: seaweedfs-volume
    ports:
      - "8080:8080"
      - "18080:18080"
      - "9327:9327"   # metrics
    command: >
      volume
      -mserver=seaweedfs-master:9333
      -ip.bind=0.0.0.0
      -dir=/data
      -max=100
      -metricsIp=0.0.0.0
      -metricsPort=9327
    volumes:
      - /mnt/data/seaweedfs/volume:/data
    networks:
      - storage-net
    depends_on:
      seaweedfs-master:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"
        reservations:
          memory: 512M
          cpus: "0.25"

  # SeaweedFS Filer
  seaweedfs-filer:
    image: chrislusf/seaweedfs:3.80
    container_name: seaweedfs-filer
    ports:
      - "8888:8888"
      - "18888:18888"
      - "9328:9328"   # metrics
    command: >
      filer
      -master=seaweedfs-master:9333
      -ip.bind=0.0.0.0
      -metricsIp=0.0.0.0
      -metricsPort=9328
    volumes:
      - /mnt/data/seaweedfs/filer:/data
    networks:
      - storage-net
    depends_on:
      seaweedfs-master:
        condition: service_healthy
      seaweedfs-volume:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8888/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"
        reservations:
          memory: 512M
          cpus: "0.5"

  # SeaweedFS S3 Gateway
  seaweedfs-s3:
    image: chrislusf/seaweedfs:3.80
    container_name: seaweedfs-s3
    ports:
      - "8333:8333"
      - "9329:9329"   # metrics
    command: >
      s3
      -filer=seaweedfs-filer:8888
      -ip.bind=0.0.0.0
      -config=/etc/seaweedfs/s3.json
      -metricsIp=0.0.0.0
      -metricsPort=9329
    environment:
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_KEY}
    volumes:
      - ./s3-config.json:/etc/seaweedfs/s3.json:ro
    networks:
      - storage-net
    depends_on:
      seaweedfs-filer:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8333 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3


  # PostgreSQL 18
  postgres:
    image: postgres:18.1-alpine
    container_name: postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: homelab
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - /mnt/data/postgres:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    networks:
      - storage-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d homelab"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: '1'
        reservations:
          memory: 1G
          cpus: '0.5'
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=1GB"
      - "-c"
      - "effective_cache_size=3GB"
      - "-c"
      - "maintenance_work_mem=256MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=5MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"

  # ========================================
  # OPTIONAL SERVICES (Currently not tested)
  # Uncomment the sections below to enable
  # ========================================

  # # Qdrant Vector Database
  # # To enable: Uncomment this entire block
  # qdrant:
  #   image: qdrant/qdrant:v1.12.5
  #   container_name: qdrant
  #   volumes:
  #     - /mnt/data/vectordb:/qdrant/storage
  #   ports:
  #     - "6333:6333"
  #     - "6334:6334"
  #   networks:
  #     - storage-net
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "wget", "-q", "--spider", "http://localhost:6333/"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 2G
  #         cpus: '0.5'
  #       reservations:
  #         memory: 1G
  #         cpus: '0.25'
  #   environment:
  #     QDRANT__SERVICE__GRPC_PORT: 6334
  #     QDRANT__SERVICE__HTTP_PORT: 6333
  #     QDRANT__LOG_LEVEL: INFO

  # # Ollama (AI Models)
  # # To enable: Uncomment this entire block
  # ollama:
  #   image: ollama/ollama:0.5.4
  #   container_name: ollama
  #   volumes:
  #     - /mnt/data/ai-models/ollama:/root/.ollama
  #   ports:
  #     - "11434:11434"
  #   networks:
  #     - storage-net
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 8G
  #         cpus: '2'
  #       reservations:
  #         memory: 2G
  #         cpus: '1'
  #   # Uncomment if you have NVIDIA GPU
  #   # runtime: nvidia
  #   # environment:
  #   #   - NVIDIA_VISIBLE_DEVICES=all

  # PostgreSQL Exporter (metrics for your cluster Prometheus)
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/homelab?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - storage-net
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9187/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'
        reservations:
          memory: 64M
          cpus: '0.1'

networks:
  storage-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

